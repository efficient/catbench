#!/bin/sh

logfilename="$CATBENCH_JAGFILE"
if [ -z "$logfilename" ]
then
	cat >&2 <<-tac
		$0: should be invoked via driver
	tac
	exit 1
fi

traverse=0
iters=1
if [ $# -eq 2 ]
then
	traverse="$1"
	iters="$2"
fi

num_trash=8
for lockserver_percent in 50 100
do
	jaguar/jaguar set "$logfilename" "data.l$lockserver_percent.description" string "Lockserver $lockserver_percent%"
	lines="integer,fraction,fraction\ntrash_percent,with_cat,no_cat"
	for trash_percent in 50 100 200 400 800
	do
		echo "Lockserver%: $lockserver_percent, Trash%: $trash_percent, Trash: $num_trash"
		sudo CATBENCH_JAGFILE="$CATBENCH_JAGFILE" ./lockserver-driver -o no-cat.dat -l "$lockserver_percent" -t "$trash_percent" -s "$traverse" -i "$iters"
		sudo CATBENCH_JAGFILE="$CATBENCH_JAGFILE" ./lockserver-driver -c -o with-cat.dat -l "$lockserver_percent" -t "$trash_percent" -s "$traverse" -i "$iters"
		lines="$lines\n$(printf "%d,%f,%f\n" "$trash_percent" "`./avg_data.pl with-cat.dat $((100 / lockserver_percent))`" "`./avg_data.pl no-cat.dat $((100 / lockserver_percent))`")"
	done
	echo "$lines" | jaguar/jaguar set "$logfilename" "data.l$lockserver_percent.samples" array -
done
