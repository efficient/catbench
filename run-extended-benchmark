#!/bin/sh

logfilename="$CATBENCH_JAGFILE"
if [ -z "$logfilename" ]
then
	cat >&2 <<-tac
		$0: should be invoked via driver
	tac
	exit 1
fi

traverse=0
iters=1
if [ $# -eq 2 ]
then
	echo "I hear you like choppier lockservers, bro. Here comes one!"
	traverse="$1"
	iters="$2"
fi

jaguar/jaguar set "$logfilename" legend.samples.trash_percent.description string "Working set size of non-lockserver processes"
jaguar/jaguar set "$logfilename" legend.samples.trash_percent.unit string "% of 1MB"
jaguar/jaguar set "$logfilename" legend.samples.no_cat.description string "Time elapsed to access memory"
jaguar/jaguar set "$logfilename" legend.samples.no_cat.unit string "s"
jaguar/jaguar set "$logfilename" legend.samples.with_cat.description string "Time elapsed to access memory"
jaguar/jaguar set "$logfilename" legend.samples.with_cat.unit string "s"

lockserver_mask="0x003"
trash_mask="0xffc"

for lockserver_percent in 50 100
do
	jaguar/jaguar set "$logfilename" "data.l$lockserver_percent.description" string "Lockserver $lockserver_percent%"
	lines="integer,fraction,fraction\ntrash_percent,with_cat,no_cat"
	for trash_percent in 50 100 200 400 800
	do
		echo "Lockserver%: $lockserver_percent, Trash%: $trash_percent, Trash: $num_trash"
		sudo CATBENCH_JAGFILE="$CATBENCH_JAGFILE" ./lockserver-driver -o no-cat.dat -l "$lockserver_percent" -d "l$lockserver_percent" -t "$trash_percent" -s "$traverse" -i "$iters"
		sudo CATBENCH_JAGFILE="$CATBENCH_JAGFILE" ./lockserver-driver -c -m "$lockserver_mask" -p "$trash_mask" -o with-cat.dat -l "$lockserver_percent" -d "l$lockserver_percent" -t "$trash_percent" -s "$traverse" -i "$iters"
		lines="$lines\n$(printf "%d,%f,%f\n" "$trash_percent" "`./avg_data.pl with-cat.dat`" "`./avg_data.pl no-cat.dat`")"
	done
	echo "$lines" | jaguar/jaguar set "$logfilename" "data.l$lockserver_percent.samples" array -
done
