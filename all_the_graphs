#!/bin/sh

if [ $# -ne 2 ]
then
	echo "Usage: $0 input_json independent_variable"
	exit 1
fi

echo "$2"
echo "$1"
name=`basename -s .json "$1"`
./strip "$1" >"$name-stripped.json"
# Replace cache ways with numbers so graphing works better
sed -i 's/"0x0*/"0x/' "$name-stripped.json"
sed -i 's/"0x1"/1/g' "$name-stripped.json"
sed -i 's/"0x3"/2/g' "$name-stripped.json"
sed -i 's/"0x7"/3/g' "$name-stripped.json"
sed -i 's/"0xf"/4/g' "$name-stripped.json"
sed -i 's/"0x1f"/5/g' "$name-stripped.json"
sed -i 's/"0x3f"/6/g' "$name-stripped.json"
sed -i 's/"0x7f"/7/g' "$name-stripped.json"
sed -i 's/"0xff"/8/g' "$name-stripped.json"
sed -i 's/"0x1ff"/9/g' "$name-stripped.json"
sed -i 's/"0x3ff"/10/g' "$name-stripped.json"
sed -i 's/"0x7ff"/11/g' "$name-stripped.json"
sed -i 's/"0xfff"/12/g' "$name-stripped.json"
sed -i 's/"0x1fff"/13/g' "$name-stripped.json"
sed -i 's/"0x3fff"/14/g' "$name-stripped.json"
sed -i 's/"0x7fff"/15/g' "$name-stripped.json"
sed -i 's/"0xffff"/16/g' "$name-stripped.json"
sed -i 's/"0x1ffff"/17/g' "$name-stripped.json"
sed -i 's/"0x3ffff"/18/g' "$name-stripped.json"
sed -i 's/"0x7ffff"/19/g' "$name-stripped.json"
sed -i 's/"0xfffff"/20/g' "$name-stripped.json"
mkdir -p ./graphs/
mkdir -p ./graphs/"$name"
# tail graphs
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata 50tail-latency --title "50% tail latency vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-50.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata 95tail-latency --title "95% tail latency vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-95.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata 99tail-latency --title "99% tail latency vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-99.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata 999tail-latency --title "99.9% tail latency vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-999.png --legend-y 0.7 --legend-x 1.5
# perf graphs
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "stalled-cycles" --title "Stalled cycles vs Mite Ways" -o ./graphs/"$name"/"$name"-stalled-cycles.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata cpu-cycles --title "CPU cycles vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-cpu-cycles.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata instructions --title "instructions vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-instructions.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L1-dcache-load-misses" --title "L1-dcache-load-misses (L1D.REPLACEMENT) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l1-dcache-load-misses.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L1-icache-load-misses" --title "L1-icache-load-misses (ICACHE.MISSES) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l1-icache-load-misses.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "dTLB-load-misses" --title "dTLB-load-misses (DTLB_LOAD_MISSES.MISS_CAUSES_A_WALK) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-dtlb-load-misses.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "MEM_UOPS_RETIRED/ALL_LOADS" --title "MEM_UOPS_RETIRED.ALL_LOADS (i.e. L1-dcache-loads, dTLB-load-misses) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-mem-uops-retired-all-loads.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata MEM_LOAD_UOPS_RETIRED/L1_MISS --title "MEM_LOAD_UOPS_RETIRED/L1_MISS vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-mem-load-uops-retired-l1-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata MEM_LOAD_UOPS_RETIRED/L2_MISS --title "MEM_LOAD_UOPS_RETIRED/L2_MISS vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-mem-load-uops-retired-l2-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "MEM_LOAD_UOPS_RETIRED/L3_MISS" --title "MEM_LOAD_UOPS_RETIRED.L3_MISS (BDE70) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-mem-uops-retired-l3-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata L2_RQSTS/DEMAND_DATA_RD_MISS --title "L2_RQSTS.DEMAND_DATA_RD_MISS vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-demand-data-rd-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata L2_RQSTS/ALL_DEMAND_DATA_RD --title "L2_RQSTS.ALL_DEMAND_DATA_RD vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-all-demand-data-rd.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata L2_RQSTS/ALL_CODE_RD --title "L2_RQSTS.ALL_CODE_RD vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-all-code-rd.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata L2_TRANS/DEMAND_DATA_RD --title "L2_RQSTS.DEMAND_DATA_RD vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-demand-data-rd.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata L2_TRANS/DEMAND_DATA_RD --title "L2_TRANS.DEMAND_DATA_RD vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-trans-demand-data-rd.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata L2_TRANS/CODE_RD --title "L2_TRANS.CODE_RD vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-trans-code-rd.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L2_RQSTS/CODE_RD_MISS" --title "L2_RQSTS.CODE_RD_MISS (HSW) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-code-rd-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L2_RQSTS/ALL_DEMAND_MISS" --title "L2_RQSTS.ALL_DEMAND_MISS (HSW) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-all-demand-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L2_RQSTS/ALL_DEMAND_REFERENCES" --title "L2_RQSTS.ALL_DEMAND_REFERENCES (HSW) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-all-demand-references.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L2_RQSTS/MISS" --title "L2_RQSTS.MISS (HSW) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "L2_RQSTS/REFERENCES" --title "L2_RQSTS.REFERENCES (HSW) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-l2-rqsts-references.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "LLC_REFERENCE" --title "LLC_REFERENCE (BDE70) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-llc-reference.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata "LLC_MISS" --title "LLC_MISS (BDE70) vs Mica Throughput Limit $2 ways" -o ./graphs/"$name"/"$name"-llc-miss.png --legend-y 0.7 --legend-x 1.5
./graph-cat.py --input "$name"-stripped.json --series allocation baseline basealloc contention --xdata "$2" --ydata contender_tput --title "Contender throughput vs Mite Ways" -o ./graphs/"$name"/"$name"-contender.png --legend-y 0.7 --legend-x 1.5
